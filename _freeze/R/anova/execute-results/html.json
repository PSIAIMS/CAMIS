{
  "hash": "398f5a0698a191e741f92fb4897964ac",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"ANOVA\"\n---\n\n\n\n## Introduction\n\nANOVA (Analysis of Variance) is a statistical method used to compare the means of three or more groups to determine if at least one group mean is significantly different from the others. It helps to test hypotheses about group differences based on sample data.\n\nThe key assumptions include:\n\n-   Independence of observations\n-   Normality of the data (the distribution should be approximately normal)\n-   Homogeneity of variances (similar variances across groups)\n\nCommon types include one-way ANOVA (one independent variable) and two-way ANOVA (two independent variables).\n\nOne-way ANOVA tests the effect of a single independent variable on a dependent variable (the grouping factor).\n\nTwo-way ANOVA tests the effect of two independent variables on a dependent variable and also examines if there is an interaction between the two independent variables.\n\n### **Getting Started**\n\nTo demonstrate the various types of sums of squares, we'll create a data frame called `df_disease` taken from the SAS documentation. The corresponding data can be found [here](https://github.com/PSIAIMS/CAMIS/blob/main/data/sas_disease.csv).\n\n\n\n\n\n\n\n### The Model {.unnumbered}\n\nFor this example, we're testing for a significant difference in `stem_length` using ANOVA. Before getting the sums of squares and associated p-values from the ANOVA, we need to fit a linear model. In R, we're using `lm()` to fit the model, and then using `broom::glance()` and `broom::tidy()` to view the results in a table format.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_model <- lm(y ~ drug + disease + drug*disease, df_disease)\n```\n:::\n\n\n\nThe `glance` function gives us a summary of the model diagnostic values.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_model %>% \n  glance() \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 12\n  r.squared adj.r.squared sigma statistic p.value    df logLik   AIC   BIC\n      <dbl>         <dbl> <dbl>     <dbl>   <dbl> <dbl>  <dbl> <dbl> <dbl>\n1     0.456         0.326  10.5      3.51 0.00130    11  -212.  450.  477.\n# ℹ 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>\n```\n\n\n:::\n:::\n\n\n\nThe `tidy` function gives a summary of the model results.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_model %>% tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 5\n   term           estimate std.error statistic      p.value\n   <chr>             <dbl>     <dbl>     <dbl>        <dbl>\n 1 (Intercept)      29.3        4.29    6.84   0.0000000160\n 2 drug2            -1.33       6.36   -0.210  0.835       \n 3 drug3           -13          7.43   -1.75   0.0869      \n 4 drug4           -15.7        6.36   -2.47   0.0172      \n 5 disease2         -1.08       6.78   -0.160  0.874       \n 6 disease3         -8.93       6.36   -1.40   0.167       \n 7 drug2:disease2    6.58       9.78    0.673  0.504       \n 8 drug3:disease2  -10.8       10.2    -1.06   0.295       \n 9 drug4:disease2    0.317      9.30    0.0340 0.973       \n10 drug2:disease3   -0.900      9.00   -0.100  0.921       \n11 drug3:disease3    1.10      10.2     0.107  0.915       \n12 drug4:disease3    9.53       9.20    1.04   0.306       \n```\n\n\n:::\n:::\n\n\n\n\n### Sums of Squares Tables {.unnumbered}\n\n#### Type I \n\nType I sums of square, also known as sequential ANOVA, is a method of analysis of variance where model terms are assessed sequentially. In this approach, the contribution of each factor or variable to the model is evaluated in the order they are specified, with each factor being adjusted for the effects of those that precede it. This means that the significance of a factor can depend on the factors that have already been included in the model. Type I ANOVA is useful for hierarchical models, where the sequence of entering factors into the model is meaningful or based on theoretical considerations. While possible to use on unbalanced designs it is often not testing the hypothesis of interest. \n\nFor a model with two factors, A and B (in that order) the sums of squares will be tested like this: \n  - SS(A) for factor A. \n  - SS(B | A) for factor B. \n  - SS(AB | B, A) for interaction AB. \n\nThis can be calculated using, the base R {stats} package or the {rstatix} package. Both give the same result. \n\n##### stats\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(lm_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Variance Table\n\nResponse: y\n             Df Sum Sq Mean Sq F value   Pr(>F)    \ndrug          3 3133.2 1044.41  9.4558 5.58e-05 ***\ndisease       2  418.8  209.42  1.8960   0.1617    \ndrug:disease  6  707.3  117.88  1.0672   0.3958    \nResiduals    46 5080.8  110.45                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n##### rstatix \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_disease %>% \n  rstatix::anova_test(\n    y ~ drug + disease + drug*disease, \n    type = 1, \n    detailed = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: NA detected in rows: 8,10,15,20,25,29,37,38,41,43,51,54,56,72.\nRemoving this rows before the analysis.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nANOVA Table (type I tests)\n\n        Effect DFn DFd      SSn      SSd     F        p p<.05   ges\n1         drug   3  46 3133.239 5080.817 9.456 5.58e-05     * 0.381\n2      disease   2  46  418.834 5080.817 1.896 1.62e-01       0.076\n3 drug:disease   6  46  707.266 5080.817 1.067 3.96e-01       0.122\n```\n\n\n:::\n:::\n\n\n\n\n#### Type II \n\nType II sum of squares also known as hierarchical or partially sequential sums of squares. Tests the effect of adding a factor to the model after all other factors have been added. This means that the significance of a factor is assessed while controlling for the effects of all other factors in the model, but not for interactions. Type II ANOVA is particularly useful when there are no interactions in the model or when the focus is on main effects only. It is often used in unbalanced designs, where the number of observations varies across groups.\n\nFor a model with two factors, A and B (in that order) the sums of squares will be tested like this: \n - SS(A | B) for factor A. \n - SS(B | A) for factor B. \n\nThis can be calculated using the {car} package or the {rstatix} package. Both give the same result.\n\n\n##### car\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAnova(lm_model, type = \"II\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnova Table (Type II tests)\n\nResponse: y\n             Sum Sq Df F value    Pr(>F)    \ndrug         3063.4  3  9.2451 6.748e-05 ***\ndisease       418.8  2  1.8960    0.1617    \ndrug:disease  707.3  6  1.0672    0.3958    \nResiduals    5080.8 46                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n##### rstatix \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_disease %>% \n  rstatix::anova_test(\n    y ~ drug + disease + drug*disease, \n    type = 2, \n    detailed = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: NA detected in rows: 8,10,15,20,25,29,37,38,41,43,51,54,56,72.\nRemoving this rows before the analysis.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nANOVA Table (type II tests)\n\n        Effect      SSn      SSd DFn DFd     F        p p<.05   ges\n1         drug 3063.433 5080.817   3  46 9.245 6.75e-05     * 0.376\n2      disease  418.834 5080.817   2  46 1.896 1.62e-01       0.076\n3 drug:disease  707.266 5080.817   6  46 1.067 3.96e-01       0.122\n```\n\n\n:::\n:::\n\n\n\n\n#### Type III \n\nType III sum of squares is calculated such that every effect is adjusted for all other effect. This means testing for the presence of a main effect after adjusting for other main effects and interactions. \nFor a model with two factors, A and B (in that order) the sums of squares will be tested like this: \n - SS(A | B, AB) for factor A. \n - SS(B | A, AB) for factor B. \n\nThis can be calculated using the base R {stats} package, the {car} package or the {rstatix} package. All give the same result. \n\nNote: Calculating type III sums of squares in R is a bit tricky, because the multi-way ANOVA model is over-paramerterised. So when running the linear model we need to select a design matrix that sums to zero. In R those options will be either `\"contr.sum\"` or `\"contr.poly\"`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Drug design matrix \ncontr.sum(4) # Using 4 here as we have 4 levels of drug \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  [,1] [,2] [,3]\n1    1    0    0\n2    0    1    0\n3    0    0    1\n4   -1   -1   -1\n```\n\n\n:::\n\n```{.r .cell-code}\n# Disease design matrix \ncontr.sum(3) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  [,1] [,2]\n1    1    0\n2    0    1\n3   -1   -1\n```\n\n\n:::\n:::\n\n\n\nWhile not relevant for this example as the disease variable isn't ordinal the polynomial design matrix would look like \n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontr.poly(3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                .L         .Q\n[1,] -7.071068e-01  0.4082483\n[2,] -9.073800e-17 -0.8164966\n[3,]  7.071068e-01  0.4082483\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_model <- lm(y ~ drug + disease + drug*disease, df_disease, \n              contrasts = list(drug = \"contr.sum\", disease = \"contr.sum\"))\n```\n:::\n\n\n\n##### stats\n\nUsing the base stats package, you can use the `drop1()` function which drops all possible single terms in a model. The scope term specifies how things can be dropped. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrop1(lm_model, scope = .~., test=\"F\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\ny ~ drug + disease + drug * disease\n             Df Sum of Sq    RSS    AIC F value    Pr(>F)    \n<none>                    5080.8 283.42                      \ndrug          3   2997.47 8078.3 304.32  9.0460 8.086e-05 ***\ndisease       2    415.87 5496.7 283.99  1.8826    0.1637    \ndrug:disease  6    707.27 5788.1 278.98  1.0672    0.3958    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n##### car\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncar::Anova(lm_model, type = \"III\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnova Table (Type III tests)\n\nResponse: y\n              Sum Sq Df  F value    Pr(>F)    \n(Intercept)  20037.6  1 181.4138 < 2.2e-16 ***\ndrug          2997.5  3   9.0460 8.086e-05 ***\ndisease        415.9  2   1.8826    0.1637    \ndrug:disease   707.3  6   1.0672    0.3958    \nResiduals     5080.8 46                       \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n##### rstatix \nThe `rstatix` package uses the `car` package to do the anova calculation, but can be nicer to use as it handles the contrasts for you and is more \"pipe-able\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_disease %>% \n  rstatix::anova_test(\n    y ~ drug + disease + drug*disease, \n    type = 3, \n    detailed = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: NA detected in rows: 8,10,15,20,25,29,37,38,41,43,51,54,56,72.\nRemoving this rows before the analysis.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nANOVA Table (type III tests)\n\n        Effect       SSn      SSd DFn DFd       F        p p<.05   ges\n1  (Intercept) 20037.613 5080.817   1  46 181.414 1.42e-17     * 0.798\n2         drug  2997.472 5080.817   3  46   9.046 8.09e-05     * 0.371\n3      disease   415.873 5080.817   2  46   1.883 1.64e-01       0.076\n4 drug:disease   707.266 5080.817   6  46   1.067 3.96e-01       0.122\n```\n\n\n:::\n:::\n\n\n\n\n#### Type IV {.unnumbered}\n\nIn R there is no equivalent operation to the `Type IV` sums of squares calculation in SAS.\n\n\n### Contrasts {.unnumbered}\n\nThe easiest way to get contrasts in R is by using `emmeans`. For looking at contrast we are going to fit a different model on new data, that doesn't include an interaction term as it is easier to calculate contrasts without an interaction term. For this dataset we have three different drugs A, C, and E.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_trial<- read.csv(\"../data/drug_trial.csv\")\n\nlm(formula = post ~ pre + drug, data = df_trial) %>% \n  emmeans(\"drug\") %>% \n  contrast(method = list(\n    \"C vs A\"  = c(-1,  1, 0),\n    \"E vs CA\" = c(-1, -1, 2)\n  ))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n contrast estimate   SE df t.ratio p.value\n C vs A      0.109 1.80 26   0.061  0.9521\n E vs CA     6.783 3.28 26   2.067  0.0488\n```\n\n\n:::\n:::\n\n\n\n## References\nGöttingen University. (n.d.). Type II and III SS using the car package. Retrieved 19 August 2025, from https://md.psych.bio.uni-goettingen.de/mv/unit/lm_cat/lm_cat_unbal_ss_explained.html#type-ii-and-iii-ss-using-the-car-package\n",
    "supporting": [
      "anova_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}