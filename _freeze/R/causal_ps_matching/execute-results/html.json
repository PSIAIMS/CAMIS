{
  "hash": "f725db8f44f5fb5f0c5e6d5a27ba8b68",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"PS matching with R\"\ncode-annotations: hover\n---\n\n\n\n## About this article\n\nThis article provide a general and simple workflow of data analysis of propensity score matching using the `MatchIt` package.\n\nThe dataset used here can be found in the data folder, with name `ps_data.csv`. It is the same data included in the **CAMIS** article on [Propensity score matching: SAS vs R](https://psiaims.github.io/CAMIS/Comp/r-sas_psmatch.html#matching-examples), which provides some good information on the comparison between SAS and R. For more details and different options, please refer to the doc there.\n\nThis article is based on the [vignette](https://cran.r-project.org/web/packages/MatchIt/vignettes/MatchIt.html) for the [MatchIt](https://cran.r-project.org/web/packages/MatchIt/index.html) package. For more implementation and methodology details, please refer to the vignette.\n\n## Propensity Score Matching with `MatchIt`\n\nA matching analysis has a few steps:\n\n1.  planning\n2.  matching\n3.  assess quality of matches\n4.  estimate treatment effect and uncertainty\n\nIn the following example, we will go through a data analysis that covers these steps.\n\n### Example\n\nWe load the dataset `ps_data`. Also load the necessary packges: `MatchIt` and `dplyr`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MatchIt)\nlibrary(dplyr)\nlibrary(optmatch)\n```\n:::\n\n\n\nInspect the dataset\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load data\ndata <- read.csv('../data/ps_data.csv')\nglimpse(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 300\nColumns: 5\n$ trtp    <chr> \"trt\", \"trt\", \"trt\", \"trt\", \"trt\", \"trt\", \"trt\", \"trt\", \"trt\",…\n$ sex     <chr> \"F\", \"F\", \"F\", \"F\", \"F\", \"F\", \"F\", \"F\", \"F\", \"F\", \"F\", \"F\", \"F…\n$ age     <int> 62, 60, 63, 98, 29, 41, 67, 53, 64, 62, 36, 63, 71, 102, 57, 4…\n$ weight  <dbl> 64.4, 67.1, 69.0, 69.0, 64.1, 62.9, 66.6, 62.1, 65.0, 74.0, 54…\n$ bmi_cat <chr> \"underweight\", \"underweight\", \"underweight\", \"underweight\", \"u…\n```\n\n\n:::\n:::\n\n\n\nDo a bit of data processing: some character variables need to be factors.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# maybe need to set factors\nvars <- c('trtp', 'sex', 'bmi_cat')\ndata[vars] <- lapply(data[vars], factor)\n```\n:::\n\n\n\n### Check initial imbalance\n\nWe need to assess the balance in the treatment variable.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(data$trtp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\ncontrol     trt \n    180     120 \n```\n\n\n:::\n:::\n\n\n\nThe pre-matching imbalance can also be assessed in the following way.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm0 <- matchit(\n  trtp ~ age + sex + weight + bmi_cat,\n  data = data,\n  method = NULL, #<1>\n  distance = \"glm\" #<2>\n)\nsummary(m0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nmatchit(formula = trtp ~ age + sex + weight + bmi_cat, data = data, \n    method = NULL, distance = \"glm\")\n\nSummary of Balance for All Data:\n                   Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance                  0.5269        0.3154          0.8805     2.0576\nage                      61.4833       49.4000          0.7057     2.6343\nsexF                      0.5833        0.5000          0.1690          .\nsexM                      0.4167        0.5000         -0.1690          .\nweight                   67.2992       63.8250          0.4741     0.5779\nbmi_catnormal             0.4750        0.3389          0.2726          .\nbmi_catoverweight         0.2417        0.3111         -0.1622          .\nbmi_catunderweight        0.2833        0.3500         -0.1479          .\n                   eCDF Mean eCDF Max\ndistance              0.2593   0.4500\nage                   0.1635   0.3722\nsexF                  0.0833   0.0833\nsexM                  0.0833   0.0833\nweight                0.1241   0.2639\nbmi_catnormal         0.1361   0.1361\nbmi_catoverweight     0.0694   0.0694\nbmi_catunderweight    0.0667   0.0667\n\nSample Sizes:\n          Control Treated\nAll           180     120\nMatched       180     120\nUnmatched       0       0\nDiscarded       0       0\n```\n\n\n:::\n:::\n\n\n\n1.  No matching is performed\n2.  `glm` for generalized linear model - logistic regression\n\nWhen checking the results, **standardized mean difference, variance ratios, eCDF** are important measures. SMD and eCDF should be close to zero, while variance ratios should be close to 1.\n\n### Nearest neighbor matching\n\nThe first matching method we use is the **1:1 nearest neighbor** (NN).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm1 <- matchit(\n  trtp ~ age + sex + weight + bmi_cat,\n  data = data,\n  method = \"nearest\", # set method NN\n  distance = \"glm\"\n)\nm1\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA `matchit` object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score\n             - estimated with logistic regression\n - number of obs.: 300 (original), 240 (matched)\n - target estimand: ATT\n - covariates: age, sex, weight, bmi_cat\n```\n\n\n:::\n:::\n\n\n\nCheck the quality of the matches.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(m1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nmatchit(formula = trtp ~ age + sex + weight + bmi_cat, data = data, \n    method = \"nearest\", distance = \"glm\")\n\nSummary of Balance for All Data:\n                   Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance                  0.5269        0.3154          0.8805     2.0576\nage                      61.4833       49.4000          0.7057     2.6343\nsexF                      0.5833        0.5000          0.1690          .\nsexM                      0.4167        0.5000         -0.1690          .\nweight                   67.2992       63.8250          0.4741     0.5779\nbmi_catnormal             0.4750        0.3389          0.2726          .\nbmi_catoverweight         0.2417        0.3111         -0.1622          .\nbmi_catunderweight        0.2833        0.3500         -0.1479          .\n                   eCDF Mean eCDF Max\ndistance              0.2593   0.4500\nage                   0.1635   0.3722\nsexF                  0.0833   0.0833\nsexM                  0.0833   0.0833\nweight                0.1241   0.2639\nbmi_catnormal         0.1361   0.1361\nbmi_catoverweight     0.0694   0.0694\nbmi_catunderweight    0.0667   0.0667\n\nSummary of Balance for Matched Data:\n                   Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance                  0.5269        0.3882          0.5774     2.3477\nage                      61.4833       52.7833          0.5081     3.1020\nsexF                      0.5833        0.5333          0.1014          .\nsexM                      0.4167        0.4667         -0.1014          .\nweight                   67.2992       66.3850          0.1247     0.6031\nbmi_catnormal             0.4750        0.3917          0.1669          .\nbmi_catoverweight         0.2417        0.3083         -0.1557          .\nbmi_catunderweight        0.2833        0.3000         -0.0370          .\n                   eCDF Mean eCDF Max Std. Pair Dist.\ndistance              0.1412   0.3667          0.5780\nage                   0.1208   0.2833          0.7066\nsexF                  0.0500   0.0500          1.0480\nsexM                  0.0500   0.0500          1.0480\nweight                0.0653   0.1333          1.2639\nbmi_catnormal         0.0833   0.0833          0.9345\nbmi_catoverweight     0.0667   0.0667          0.9733\nbmi_catunderweight    0.0167   0.0167          0.7767\n\nSample Sizes:\n          Control Treated\nAll           180     120\nMatched       120     120\nUnmatched      60       0\nDiscarded       0       0\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm1$weights # membership, 1 or 0\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20 \n  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 \n 21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40 \n  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 \n 41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60 \n  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 \n 61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79  80 \n  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 \n 81  82  83  84  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100 \n  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 \n101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 \n  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 \n121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 \n  1   1   0   1   1   0   0   1   1   0   0   0   0   0   0   0   1   1   0   1 \n141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 \n  0   0   1   1   1   0   1   0   1   1   1   0   0   1   1   1   1   1   0   1 \n161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 \n  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   0   1   1   1 \n181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 \n  1   1   0   0   1   1   0   1   1   1   1   1   1   1   1   1   1   1   0   1 \n201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 \n  1   1   1   0   0   0   1   1   1   1   0   0   0   0   1   1   0   1   0   1 \n221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 \n  1   1   1   1   0   1   1   1   1   0   0   1   0   1   1   0   1   1   1   1 \n241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 \n  1   0   1   0   1   1   0   1   0   1   1   1   1   1   1   0   1   1   1   1 \n261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 \n  0   0   1   0   1   1   1   0   0   1   0   1   1   1   1   1   1   0   1   1 \n281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 \n  1   0   1   1   1   0   0   0   1   1   0   0   0   1   0   1   1   0   0   0 \n```\n\n\n:::\n\n```{.r .cell-code}\nm1$weights |> table() # 244 unmatched, 370 (185:185 tr ct)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  0   1 \n 60 240 \n```\n\n\n:::\n:::\n\n\n\nCan also visualize the PS after matching.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(m1, type = \"jitter\", interactive = FALSE)\n```\n\n::: {.cell-output-display}\n![](causal_ps_matching_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n### Full matching\n\nA different method can be used (full matching).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm2 <- matchit(\n  trtp ~ age + sex + weight + bmi_cat,\n  data = data,\n  method = \"full\",\n  distance = \"glm\",\n  link = \"probit\"\n)\nsummary(m2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nmatchit(formula = trtp ~ age + sex + weight + bmi_cat, data = data, \n    method = \"full\", distance = \"glm\", link = \"probit\")\n\nSummary of Balance for All Data:\n                   Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance                  0.5276        0.3179          0.8789     2.0294\nage                      61.4833       49.4000          0.7057     2.6343\nsexF                      0.5833        0.5000          0.1690          .\nsexM                      0.4167        0.5000         -0.1690          .\nweight                   67.2992       63.8250          0.4741     0.5779\nbmi_catnormal             0.4750        0.3389          0.2726          .\nbmi_catoverweight         0.2417        0.3111         -0.1622          .\nbmi_catunderweight        0.2833        0.3500         -0.1479          .\n                   eCDF Mean eCDF Max\ndistance              0.2574   0.4417\nage                   0.1635   0.3722\nsexF                  0.0833   0.0833\nsexM                  0.0833   0.0833\nweight                0.1241   0.2639\nbmi_catnormal         0.1361   0.1361\nbmi_catoverweight     0.0694   0.0694\nbmi_catunderweight    0.0667   0.0667\n\nSummary of Balance for Matched Data:\n                   Means Treated Means Control Std. Mean Diff. Var. Ratio\ndistance                  0.5276        0.5207          0.0291     1.0618\nage                      61.4833       56.4109          0.2962     2.2516\nsexF                      0.5833        0.6848         -0.2058          .\nsexM                      0.4167        0.3152          0.2058          .\nweight                   67.2992       70.6259         -0.4540     0.4518\nbmi_catnormal             0.4750        0.6306         -0.3116          .\nbmi_catoverweight         0.2417        0.1712          0.1647          .\nbmi_catunderweight        0.2833        0.1982          0.1889          .\n                   eCDF Mean eCDF Max Std. Pair Dist.\ndistance              0.0084   0.1167          0.0363\nage                   0.0729   0.2028          0.5135\nsexF                  0.1015   0.1015          0.9918\nsexM                  0.1015   0.1015          0.9918\nweight                0.0805   0.2732          1.2674\nbmi_catnormal         0.1556   0.1556          0.8822\nbmi_catoverweight     0.0705   0.0705          0.8232\nbmi_catunderweight    0.0851   0.0851          0.9385\n\nSample Sizes:\n              Control Treated\nAll            180.       120\nMatched (ESS)   29.88     120\nMatched        180.       120\nUnmatched        0.         0\nDiscarded        0.         0\n```\n\n\n:::\n:::\n\n\n\nAssess the balance with **Love plot**. Read more in `vignette('assessing-balance')`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(summary(m2))\n```\n\n::: {.cell-output-display}\n![](causal_ps_matching_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n### Estimate treatment effect\n\nFirst match the data. We focus on the full matching. Some new columns are added.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm.data <- match_data(m2)\nhead(m.data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  trtp sex age weight     bmi_cat   distance weights subclass\n1  trt   F  62   64.4 underweight 0.49077924       1        1\n2  trt   F  60   67.1 underweight 0.48967733       1        1\n3  trt   F  63   69.0 underweight 0.55924944       1       29\n4  trt   F  98   69.0 underweight 0.93988057       1       35\n5  trt   F  29   64.1 underweight 0.08752362       1       39\n6  trt   F  41   62.9 underweight 0.18167583       1       45\n```\n\n\n:::\n:::\n\n\n\nFit model with weights\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit <- lm(\n  weight ~ trtp + age + sex + bmi_cat,\n  data = m.data, #<1>\n  weights = weights #<2>\n)\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = weight ~ trtp + age + sex + bmi_cat, data = m.data, \n    weights = weights)\n\nWeighted Residuals:\n    Min      1Q  Median      3Q     Max \n-38.881  -5.868  -1.966   1.987  52.368 \n\nCoefficients:\n                   Estimate Std. Error t value Pr(>|t|)    \n(Intercept)        71.88164    2.47256  29.072  < 2e-16 ***\ntrtptrt            -2.59401    1.13479  -2.286 0.022972 *  \nage                 0.01184    0.03942   0.300 0.764090    \nsexM               -0.50322    1.13855  -0.442 0.658824    \nbmi_catoverweight  -5.40009    1.42960  -3.777 0.000192 ***\nbmi_catunderweight -4.24149    1.34187  -3.161 0.001737 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 9.272 on 294 degrees of freedom\nMultiple R-squared:  0.09304,\tAdjusted R-squared:  0.07761 \nF-statistic: 6.032 on 5 and 294 DF,  p-value: 2.476e-05\n```\n\n\n:::\n:::\n\n\n\n1.  use the matched data\n2.  add weights. this is a column in `m.data`\n\nIn the end, you can also compare it with the model without matching (`lm`).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit0 <- lm(\n  weight ~ trtp + age + sex + bmi_cat,\n  data = data\n)\nsummary(fit0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = weight ~ trtp + age + sex + bmi_cat, data = data)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-27.902  -5.725   0.356   5.487  23.530 \n\nCoefficients:\n                   Estimate Std. Error t value Pr(>|t|)    \n(Intercept)        66.86591    2.16059  30.948   <2e-16 ***\ntrtptrt             3.55584    1.14027   3.118   0.0020 ** \nage                -0.03191    0.03753  -0.850   0.3959    \nsexM                0.05071    1.02071   0.050   0.9604    \nbmi_catoverweight  -2.39144    1.25778  -1.901   0.0582 .  \nbmi_catunderweight -2.13108    1.21236  -1.758   0.0798 .  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 8.771 on 294 degrees of freedom\nMultiple R-squared:  0.05354,\tAdjusted R-squared:  0.03744 \nF-statistic: 3.326 on 5 and 294 DF,  p-value: 0.006142\n```\n\n\n:::\n:::\n\n\n\nInterpreting the result is a different topic, which is not covered in this article.\n\n## Summary\n\nThere are many diffrent methods implemented in the `MatchIt` package that we have not elaborated in this article. Please read the [MatchIt vignette](https://cran.r-project.org/web/packages/MatchIt/vignettes/MatchIt.html) for more details on the options.\n",
    "supporting": [
      "causal_ps_matching_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}