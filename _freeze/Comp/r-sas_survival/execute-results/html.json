{
  "hash": "8b2e2825d154eb0c146e3f2634114601",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"R vs SAS - Kaplan Meier and Cox-proportion hazards modelling\"\n---\n\n\n\n# Comparison of SAS vs R\n\nThe following table shows the options available in SAS and R for Kaplan Meier and Cox Proportional Hazards modelling, the capabilities of each language, and whether or not the results from each language match.\n\n+-------------------------------------------------------------------------------+----------------------------------------------+----------------------------------------+---------------+--------------------------------------------------------------------------------------------------------------------------------------+\n| Analysis                                                                      | Supported in R                               | Supported in SAS                       | Results Match | Notes                                                                                                                                |\n+===============================================================================+==============================================+========================================+===============+======================================================================================================================================+\n| Kaplan Meier with confidence intervals using log-log method                   | Yes (using the option conf.type = \"log-log\") | Yes (Default)                          | Mostly        | 1\\) Survival estimates can disagree when last event is censored and survival estimate does not cross the percentile being estimated. |\n|                                                                               |                                              |                                        |               |                                                                                                                                      |\n|                                                                               |                                              |                                        |               | 2\\) Survival estimates at time X can disagree when the time X is after the last observed censored time                               |\n+-------------------------------------------------------------------------------+----------------------------------------------+----------------------------------------+---------------+--------------------------------------------------------------------------------------------------------------------------------------+\n| Kaplan Meier with confidence intervals using log method                       | Yes (Default)                                | Yes (using the option conftype=log)    | Mostly        | As above.                                                                                                                            |\n+-------------------------------------------------------------------------------+----------------------------------------------+----------------------------------------+---------------+--------------------------------------------------------------------------------------------------------------------------------------+\n| Cox Proportional Hazards Model using breslow method for ties                  | Yes (using the option ties=\"breslow\")        | Yes (Default)                          | Yes           |                                                                                                                                      |\n+-------------------------------------------------------------------------------+----------------------------------------------+----------------------------------------+---------------+--------------------------------------------------------------------------------------------------------------------------------------+\n| Cox Proportional Hazards Model using efron method for ties                    | Yes (Default)                                | Yes (using the option ties=efron)      | Yes           |                                                                                                                                      |\n+-------------------------------------------------------------------------------+----------------------------------------------+----------------------------------------+---------------+--------------------------------------------------------------------------------------------------------------------------------------+\n| Cox Proportional Hazards Model using exact partial likelihood method for ties | Yes (using the option ties=\"exact\")          | Yes (using the option ties=\"discrete\") | Yes           | The option ties=\"exact\" in SAS uses the exact marginal likelihood which is not available in R                                        |\n+-------------------------------------------------------------------------------+----------------------------------------------+----------------------------------------+---------------+--------------------------------------------------------------------------------------------------------------------------------------+\n\nResults from the examples shown for R [here](https://psiaims.github.io/CAMIS/R/survival.html) and SAS [here](https://psiaims.github.io/CAMIS/SAS/survival.html) were compared below.\n\nComparing the non-stratified model results side-by-side, the CIs for the quartile estimates and landmark estimates are different between R and SAS. HR and CI also have slight differences.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](../images/survival/r_sas_default.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\n## Reason 1: Cox Regression Handling of Tied Survival Times\n\nThe default methods for handling ties in a Cox regression model are different which can lead to a different result for the Hazard ratio and associated confidence interval.\n\nR uses \"efron\" by default. SAS uses \"breslow\" by default. Both R and SAS are able to change these default options. By making the changes to the code below, we can force R to use \"breslow\" to match SAS, or SAS to use \"efron\" to match R. When the software use the same methods, then we obtain an identical HR and CI.\n\n-   R: change method for ties to use \"breslow\"\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.cox <- coxph(Surv(LENFOLY, FSTAT) ~ AFB, ties = \"breslow\", data = dat)\n```\n:::\n\n\n\n-   SAS: change method for ties to use \"efron\"\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproc phreg data=dat;\nclass afb;\nmodel lenfol*fstat(0) = afb/rl ties = efron;\nrun;\n```\n:::\n\n\n\nIf there are no tied event times, then the methods are equivalent.\n\nThe Breslow approximation is the easiest to program and hence it historically became the first option coded for almost all software. It then ended up as the default option when other options were added in order to maintain \"backwards compatibility\". The Efron option is more accurate if there are a large number of ties, and it was therefore selected as the default option in R. In practice the number of ties is usually small, in which case all the methods are statistically indistinguishable.\n\nFrom the arguments of `coxph` in R, there are three possible choices for handling tied event times 'ties=breslow', 'ties=efron', or 'ties=exact'. This last option is an exact partial likelihood approach, and corresponds to the \"discrete\" method in SAS. See [here](https://www.rdocumentation.org/packages/survival/versions/3.5-8/topics/coxph) for more detail. (For {survival} versions prior to 3.2-14, the options are 'ties=breslow', 'ties=efron', or 'ties=logit'.)\n\n## Reason 2: Kaplan Meier Median Survival Confidence Intervals\n\nThe default methods for calculation of the confidence interval of a KM estimator are different in the two languages (for example, for calculation of the CI associated with the Median Survival estimate, the 25th percentile and the 75th percentile).\n\nR uses \"log\" by default, and SAS uses \"log-log\" by default. As shown below, using 'conf.type' option, R can be forced to use the \"log-log\" method to match SAS. Alternatively, using the 'conftype=' option, SAS can be forced to use the \"log\" method to match R.\n\n-   R: change to \"log-log\"\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.km <- survfit(Surv(LENFOLY, FSTAT) ~ AFB, conf.type = \"log-log\", data = dat)\n```\n:::\n\n\n\n-   SAS: change to \"log\"\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproc lifetest data=dat conftype=log;\ntime lenfoly*fstat(0);\nstrata afb;\nrun;\n```\n:::\n\n\n\n\"log-log\" prevents the problem of having confidence intervals of \\>1 or \\<0, which might happen if using \"log\" transformation. However, both R and SAS will clip the interval at \\[0, 1\\] and report a bound \\>1 as 1 and \\<0 as 0.\n\nFrom a [reference](https://myweb.uiowa.edu/pbreheny/7210/f15/notes/9-10.pdf): The appeal of the log-log interval is clear, but the log-scale interval has the advantage of variance stabilization. As a result, simulation studies have generally found it to have better (closer to nominal) coverage; for this reason, it is the default in the `survival` package.\n\nNow if we change the confidence interval type in SAS to \"log\" and tie handling to \"efron\", the results will be identical to the results in R.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](../images/survival/r_sas_chg_default.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\nBelow is the side-by-side comparison for stratified analysis with default methods in SAS matched to R's, the results are also identical.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](../images/survival/r_sas_stratified.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\n## Reason 3: Convergence Criteria in Cox Proportional Hazards Model\n\nAnother source of discrepancy between R and SAS in Cox models can arise from\nthe default convergence criteria used by the two software packages.\n\nIn R, the `survival::coxph()` function has a default convergence criterion\nfor the relative change in log partial likelihood set at `1e-9`.\nOn the other hand, SAS's `PHREG` procedure uses a default convergence criterion\nfor the relative gradient convergence set at `1e-8`. This discrepancy in the\nconvergence criteria can lead to slight differences in the hazard ratios (HR)\nobtained from the two software packages.\n\nTo achieve comparable results, it is possible to adjust the convergence\ncriteria in SAS to match the more stringent criteria used by R.\nThis can be done by specifying the `fconv` option in the model statement\nwithin `PHREG` to change the criteria to relative function convergence\nwith a value of `1e-9`.\n\n- R: default convergence criterion\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.cox <- coxph(Surv(LENFOLY, FSTAT) ~ AFB, data = dat)\n```\n:::\n\n\n\n- SAS: adjust convergence criterion\n\n\n\n::: {.cell}\n\n```{.sas .cell-code}\nproc phreg data=dat;\nclass afb;\nmodel lenfol*fstat(0) = afb / rl fconv = 1e-9;\nrun;\n```\n:::\n\n\n\nBy making this adjustment, the hazard ratios obtained from SAS will align\nmore closely with those from R or even achieve bitwise reproducibility.\n\nThe convergence criterion details are described in their documentation:\n\n- [SAS PHREG documentation](https://support.sas.com/documentation/onlinedoc/stat/131/phreg.pdf).\n- [R `survival::coxph()` documentation](https://stat.ethz.ch/R-manual/R-devel/library/survival/html/coxph.html).\n- [R `survival::coxph.control()` ancillary arguments documentation](https://stat.ethz.ch/R-manual/R-devel/library/survival/html/coxph.control.html).\n\n# Other Cases Where Discrepancies Are Found\n\nNow we look at other cases when the data has some special type which causes a mismatch between SAS and R. Suppose a dataset has 10 observations, and the first 5 are all events, and the last 5 are all censored.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest <- tibble(time = c(54, 75, 77, 84, 87, 92, 103, 105, 112, 118), \n                   status = c(1, 1, 1, 1, 1, 0, 0, 0, 0, 0))\n\ntest\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 2\n    time status\n   <dbl>  <dbl>\n 1    54      1\n 2    75      1\n 3    77      1\n 4    84      1\n 5    87      1\n 6    92      0\n 7   103      0\n 8   105      0\n 9   112      0\n10   118      0\n```\n\n\n:::\n:::\n\n\n\n## Differences Observed in the KM Estimators\n\nSuppose we are interested to know the 25%, 50% and 75% quartile estimates, and the day 80, 100, and 120 estimates.\n\nBelow is the R code:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.km <- survfit(Surv(time, status) ~ 1, conf.type = \"log-log\", data = test)\n## quantile estimates\nquantile(fit.km, probs = c(0.25, 0.5, 0.75))\n## landmark estimates at 80, 100, 120-day\nsummary(fit.km, times = c(80, 100, 120), extend = T)\n```\n:::\n\n\n\nBelow is the SAS code:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproc lifetest data=dat outsurv=_SurvEst timelist= 80 100 120 reduceout stderr; \ntime lenfoly*fstat(0);\nrun;\n```\n:::\n\n\n\nBelow is the side-by-side comparison:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](../images/survival/r_sas_special.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\n## Reasons\n\nThe reasons for the differences are because:\n\n**Reason 1: Survival estimate does not cross the 50% percentile.**\n\nThe kth quantile for a survival curve S(t) is the location at which a horizontal line at height p= 1-k intersects the plot of S(t) as shown in the KM curve below. Since S(t) is a step function, it is possible for the curve to have a horizontal segment at exactly 1-k, in which case the midpoint of the horizontal segment is returned.\n\nFor example, using the data above, the survival probability is exactly 0.5 at time=87 and remains at 0.5 until the last censored observation at 118.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](../images/survival/other_diff_km.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\nWhen using R, the median is the smallest time which survival estimate is \\<= 0.5 --\\> `(87+118) / 2 = 102.5.` However, SAS searches the smallest time which survival estimate is \\< 0.5, which does not exist in this dataset, so it gives \"NE\" (Not evaluable).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npl <- survminer::ggsurvplot(fit.km, \n                            conf.int = TRUE,\n                            ggtheme = theme_light()) \npl$plot +  geom_hline(yintercept = 0.5, color = \"black\", linetype = \"solid\")  \n\nsummary(fit.km)\n```\n:::\n\n\n\n**Reason 2: Last event censored and prior to the required landmark estimate.**\n\nFor the 120-day event-free estimate, SAS considers that 120 days is beyond the maximum observed day in the data (which was a censored event at time =118). Therefore, SAS considers this as Unknown and returns a result of \"NE\" (Not-evaluable). However, R uses the rate at last observed censored date to estimate the 120-day event free rate. As the event-free estimate at time of the last censored event at 118 was 0.5 (0.184, 0.753), R makes the assumption that this is the best estimate for the event-free rate at Time =120.\n\nIf we change the last observation in the dataset to be an event (instead of censored), R and SAS will both give 0 for the event-free survival estimate, because it is for sure that all subjects did not survive beyond 120 days.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest <- tibble(time = c(54, 75, 77, 84, 87, 92, 103, 105, 112, 118), \n                   status = c(1, 1, 1, 1, 1, 0, 0, 0, 0, 1))\n\ntest\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 2\n    time status\n   <dbl>  <dbl>\n 1    54      1\n 2    75      1\n 3    77      1\n 4    84      1\n 5    87      1\n 6    92      0\n 7   103      0\n 8   105      0\n 9   112      0\n10   118      1\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](../images/survival/r_sas_special_lst.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\n# References\n\nBreheny P. \"Inference for the Kaplan-Meier Estimator.\" https://myweb.uiowa.edu/pbreheny/7210/f15/notes/9-10.pdf\n\nBreslow, N. E. (1974) \"Covariance Analysis of Censored Survival Data.\" Biometrics 30:89--99.\n\nEfron, B. (1977. \"The Efficiency of Cox's Likelihood Function for Censored Data.\" Journal of the American Statistical Association 72:557--565.\n\nEmmerson J. and Brown J. M. \"Understanding Survival Analysis in Clinical Trials.\" Clinical Onclogy 33:12-14.\n\nFranklin D. \"Our Survival Confidence Intervals are not the Same!\" PharmaSUG 2014 - Paper SP10. https://www.pharmasug.org/proceedings/2014/SP/PharmaSUG-2014-SP10.pdf\n\nHertz-Picciotto I. and Rockhill B. (1997) \"Validity and efficiency of approximation methods for tied survival times in Cox regression.\" Biometrics 53:1151-1156.\n\nHosmer, D.W. and Lemeshow, S. and May, S. (2008) \"Applied Survival Analysis: Regression Modeling of Time to Event Data: Second Edition.\" John Wiley and Sons Inc., New York, NY\n\n[SAS PROC LIFETEST Documentation](https://documentation.sas.com/doc/en/statug/15.2/statug_lifetest_details03.htm)\n\n[SAS PROC PHREG Documentation](https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.4/statug/statug_phreg_toc.htm)\n",
    "supporting": [
      "r-sas_survival_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}