---
title: "R vs SAS ANOVA"
execute: 
    eval: false
---

# R vs. SAS ANOVA

## Introduction

This section compares the implementation of analysis of variance (ANOVA) in R and SAS. ANOVA compares the mean of two or more groups to determine if at least one group is significantly different from the others.

**Example:** This section compares the implementation of ANOVA in R and SAS on linear models. ANOVA has 3 main assumptions: homogeneity of variance, independence of observations, and normality.

## General Comparison Table

The following table provides an overview of the support and results comparability between R and SAS for the new analysis point.

| Analysis | Supported in R | Supported in SAS | Results Match | Notes          |
|----------|----------------|------------------|---------------|----------------|
| ANOVA    | Yes            | Yes              | Mostly yes    | Mostly matches |

List the R packages required for this analysis. Include a brief description if necessary.

`{r} # List R packages needed library("emmeans")`

**Note:** It is recommended to use the emmeans package when attempting to match contrasts between R and SAS. In SAS, all contrasts must be manually defined, whereas in R, we have many ways to use pre-existing contrast definitions. The emmeans package makes simplifies this process, and provides syntax that is similar to the syntax of SAS.

## Example Data

Below is the example dataset generated by R.

```{r}
#For reproducibility
set.seed(123)  

#Define number of subjects
n_subjects <- 30  # Multiple of 3 for equal group sizes

# Create SubjectID
SubjectID <- 1:n_subjects

#Assign drug groups: C, A, E
drug <- rep(c("C", "A", "E"), each = n_subjects / 3)

#Generate 'pre' values
pre <- sample(148:153, n_subjects, replace = TRUE)

#Generate 'post' values: slightly lower than 'pre'
post <- pre - sample(1:5, n_subjects, replace = TRUE)

#Combine into a data frame
clinicaltrial <- data.frame(SubjectID, drug, pre, post)

print(clinicaltrial)

```

Below is the example dataset generated by SAS.

```{SAS}

data clinicaltrial;
    call streaminit(123); /*Set random seed for reproducibility.*/
    do SubjectID = 1 to 30;
        if SubjectID <= 10 then drug = 'C';
        else if SubjectID <= 20 then drug = 'A';
        else drug = 'E';
        
        pre = rand("integer", 148, 153);
        reduction = rand("integer", 1, 5);
        post = pre - reduction;

        output;
    end;
run;

/*View the generated dataset */
proc print data=clinicaltrial;
run;
```

## Analysis Scenarios

### Scenario 1: Basic Functionality

#### R Code Example

Below is how we would yield the ANOVA in R, using the `emmeans` package.

```{r}
setwd("C:/Users/Dimple/Desktop/PHUSE/CAMIS/CAMIS/")
library(readr)
library(magrittr)
library(emmeans)

lm(formula = post ~ pre + drug, data = clinicaltrial_csv) %>% 
  emmeans("drug") %>% 
  contrast(method = list(
    "C vs A"  = c(-1,  1, 0),
    "E vs CA" = c(-1, -1, 2)
  ))


```

Below is how we would yield the ANOVA in SAS, using the PROC GLM step.

```{SAS}
# In SAS
proc glm data=work.mycsv;
   class drug;
   model post = drug pre / solution;
   estimate 'C vs A'  drug -1  1 0;
   estimate 'E vs CA' drug -1 -1 2;
run;
```

#### Results Comparison

Provided below is a detailed comparison of the results obtained from both SAS and R.

| Statistic | R Result | SAS Result | Match | [Notes]{.underline} |
|----|----|----|----|----|
| ***contrast estimate C vs A*** | 9.38 | 9.38 | Yes |  |
| SE | .671 | .671 | Yes |  |
| Degrees of Freedom | 11 | 11 | Yes |  |
| t\. ratio | 13.976 | 13.98 | Mostly yes |  |
| p-value | \<0.0001 | \<0.0001 | Yes |  |
| ***contrast estimate E vs CA*** | -27.08 | -27.08 | Yes |  |
| SE | 1.090 | 1.086 | Partially yes |  |
| Degrees of Freedom | 11 | 11 | Yes |  |
| t\. ratio | -24.928 | -24.93 | Mostly yes |  |
| p-value | \<0.0001 | \<0.0001 | Yes |  |

### Scenario 2: Advanced Feature

Note, however, that there are some cases where the scale of the parameter estimates between SAS and R is off, though the test statistics and p-values are identical. In these cases, we can adjust the SAS code to include a divisor.

The following is SAS code with the parameter estimates at a scale:

```{SAS}
proc glm data=work.mycsv;
   class drug;
   model post = drug pre / solution;
   estimate 'C vs A'  drug -1  1 0 / divisor = 2;
   estimate 'E vs CA' drug -1 -1 2 / divisor = 6;
run;
```

The following is R code with the parameter estimates at a scale:

```{r}
setwd("C:/Users/Dimple/Desktop/PHUSE/CAMIS/CAMIS/")
library(magrittr)
library(emmeans)

clinicaltrial_csv$drug <- factor(clinicaltrial_csv$drug, levels = c("C", "A", "E"))

model <- lm(post ~ pre + drug, data = clinicaltrial_csv)

emmeans(model, "drug") %>% 
  contrast(
    method = list(
      "C vs A"  = c(-0.5, 0.5, 0),   # Divided by 2
      "E vs CA" = c(-1/6, -1/6, 2/6) # Divided by 6
    )
  )

```

#### Results Comparison

Provided below is a detailed comparison of the results obtained from both SAS and R. Highlight any differences and provide explanations if possible.

| Statistic | R Result | SAS Result | Match | [Notes]{.underline} |
|----|----|----|----|----|
| ***contrast estimate C vs A*** | -4.69 | 4.69 | No |  |
| SE | .336 | .34 | Mostly yes |  |
| Degrees of Freedom | 11 | 11 | Yes |  |
| t\. ratio | -13.976 | 13.98 | Mostly yes |  |
| p-value | \<0.0001 | \<0.0001 | Yes |  |
| ***contrast estimate E vs CA*** | -4.51 | -4.51 | Yes |  |
| SE | .181 | .181 | Partially yes |  |
| Degrees of Freedom | 11 | 11 | Yes |  |
| t\. ratio | -24.928 | -24.93 | Mostly yes |  |
| p-value | \<0.0001 | \<0.0001 | Yes |  |

## Summary and Recommendation

There were no major differences between the R emmeans package and the SAS PROC GLM step in conducting ANOVA on the clinical trial data. Both are robust software tools that generate mostly same results. Scaling for parameter coefficients need to be handled with care however as contrast estimates between R and S differed by a sign.

## Additional References

Provide references and additional reading materials for both R and SAS documentation related to the analysis.

**R Documentation:**

-   `lm` function: <https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/lm>
-   `emmeans` package: <https://cran.r-project.org/web/packages/emmeans/>

**SAS Documentation:**

-   `PROC GLM`: <https://documentation.sas.com/doc/en/statug/15.2/statug_glm_syntax01.htm>

\`\`\`
