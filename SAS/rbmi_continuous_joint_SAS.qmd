---
title: "<SAS> <Reference-Based Multiple Imputation (joint modelling): Continuous Data>"
---

## Reference-based multiple imputation (rbmi)

### Methodology introduction
[To be copied from R implementation]

### 5 Macro's
[Tina] can you add?


## Data used

A publicly available example [dataset](https://r-packages.io/datasets/antidepressant_data) from an antidepressant clinical trial of an active drug versus placebo is used. Overall, data of 172 patients is available with 88 patients receiving placebo and 84 receiving active drug. More information on the data is available in the [R part](../R/rbmi_continuous_joint.html).


## Complete case analysis

A complete case analysis is performed using mixed model for repeated measures (MMRM) with covariates: treatment [THERAPY], gender [GENDER], visit [VISIT] as factors; baseline score [BASVAL] as continuous; and visit-by-treatment [THERAPY * VISIT] interaction, and visit-by-baseline [BASVAL * VISIT] interaction. An unstructured covariance matrix is used.
The **MIXED** procedure is used.

```{r}
#| eval: false
proc mixed data=dat method=reml;
	class THERAPY(ref="PLACEBO") VISIT(ref="7") PATIENT GENDER(ref="F");
	model CHANGE = THERAPY VISIT BASVAL BASVAL*VISIT THERAPY*VISIT GENDER /s ddfm=satterthwaite;
	repeated VISIT / type=UN subject=PATIENT;
	lsmeans THERAPY*VISIT / diff=control("PLACEBO" "7") cl;
run;
```


The parameter estimates of the fixed effects are:
```{r, echo=FALSE, fig.align='center', out.width="80%"}
knitr::include_graphics("../images/rbmi/SAS_CompleteCase_fixedEstimates.PNG")
```


The estimated unstructured covariance matrix parameters are:
```{r, echo=FALSE, fig.align='center', out.width="80%"}
knitr::include_graphics("../images/rbmi/SAS_CompleteCase_covarianceEstimates.PNG")
```

The contrasts are. The treatment difference at visit 7 is of interest, and is estimated to be 2.829 (se=1.117) with 95% CI of 0.623 - 5.035 (p=0.0123).
```{r, echo=FALSE, fig.align='center', out.width="90%"}
knitr::include_graphics("../images/rbmi/SAS_CompleteCase_contrastEstimates.PNG")
```

## rbmi: MAR approach

As described above, the so-called 5 macros will be used for the SAS implementation. The 5 macros are available at [LSHTM DIA Missing Data](https://www.lshtm.ac.uk/research/centres-projects-groups/missing-data#dia-missing-data) under Reference-based MI via Multivariate Normal RM (the "five macros and MIWithD"). For the details, see the use guide available in the download of the 5 macros.

Applying the 5 macros for reference-based multiple imputation entails the sequential run of the following 5 macro's.

- Part1A declares the parameter estimation model and checks consistency with the dataset. It builds a master dataset which holds details of the current job (run of the macros in sequence). It also builds indexes for the classification variables, which may be either numeric or character.

- Part1B fits the parameter estimation model using the MCMC procedure and draws a pseudo-independent sample from the joint posterior distribution for the linear predictor parameters and the covariance parameters.

- Part2A calculates the predicted mean under MAR, and under MNAR for each subject based on their withdrawal pattern once for each draw of the linear predictor parameter estimates. The choice of MNAR is controlled by the method used, which may vary from subject to subject.

- Part2B imputes the intermediate missing values using MAR and the trailing missing values using MNAR, by deriving the conditional distribution for the missing values conditional on the observed values and covariates, using the appropriate sampled covariance parameter estimates.

- Part3 carries out a univariate ANOVA analysis at selected time points usually based on the same covariates as the parameter estimation model. It then combines the least-squares means and their differences using the MIANALYZE procedure to provide final results. It is in this macro which handles the Delta methods.

Most of the computation time is spent in the Part1B macro where the MCMC procedure is used to generate a sample from the posterior distribution of the full set of model parameters. These are stored away and can be used repeatedly by calling the later macros over and over again using different imputation methods.

To perform reference-based multiple imputation using MAR approach to following code is used
```{r}
#| eval: false
%part1A(jobname = HAMD, 
        Data=dat,
        Subject=PATIENT,
        RESPONSE = CHANGE,
        Time = VISIT,
        Treat = THERAPY,
        Covbytime = BASVAL,
        Catcov = GENDER);
%part1B(jobname = HAMD,
        Ndraws = 500,
        thin = 10,
        seed = 12345);
%part2A(jobname = HAMD_MAR,
        inname = HAMD,
        method = MAR);
%part2B(jobname = HAMD_MAR,
        seed = 12345);
%part3(Jobname = HAMD_MAR,
       anref = PLACEBO,
       Label = MAR);
```

To print the results of the contrast at week 7 
```{r}
#| eval: false
proc print data=HAMD_MAR_OUT;
	where VISIT = "7";
	var VISIT THERAPY _THERAPY Diff SE_Diff df Probt LCL_Diff UCL_Diff;
run;
```

```{r, echo=FALSE, fig.align='center', out.width="90%"}
knitr::include_graphics("../images/rbmi/SAS_MAR_Contrast.PNG")
```


## rbmi: MNAR CR approach

To perform reference-based multiple imputation using Copy Reference (CR) approach the following changes are needed in part2A of the 5 macros
```{r}
#| eval: false
%part2A(jobname = HAMD_CR,
        inname = HAMD,
        method = CR,
        ref = PLACEBO);
```

The results for 500 imputations are
```{r, echo=FALSE, fig.align='center', out.width="90%"}
knitr::include_graphics("../images/rbmi/SAS_MNAR_CR_contrast.PNG")
```


## rbmi: MNAR J2R approach

To perform reference-based multiple imputation using Jump to Reference (J2R) approach the following changes are needed in part2A of the 5 macros
```{r}
#| eval: false
%part2A(jobname = HAMD_J2R,
        inname = HAMD,
        method = J2R,
        ref = PLACEBO);
```

The results for 500 imputations are
```{r, echo=FALSE, fig.align='center', out.width="90%"}
knitr::include_graphics("../images/rbmi/SAS_MNAR_J2R_contrast.PNG")
```


## rbmi: MNAR CIR approach

To perform reference-based multiple imputation using Copy Increments in Reference (CIR) approach the following changes are needed in part2A of the 5 macros
```{r}
#| eval: false
%part2A(jobname = HAMD_CIR,
        inname = HAMD,
        method = CIR,
        ref = PLACEBO);
```

The results for 500 imputations are
```{r, echo=FALSE, fig.align='center', out.width="90%"}
knitr::include_graphics("../images/rbmi/SAS_MNAR_CIR_contrast.PNG")
```



## Summary of results

In the table we present the results of the different estimation procedures (and with different number $B$ of multiple imputation draws). Note that some results can be slightly different from the results above due to a possible different seed. The table show the contrast at Visit 7 between DRUG and PLACEBO [DRUG - PLACEBO]:

| Method            | Estimate | SE    | 95% CI           | p-value |
|-------------------|----------|-------|------------------|---------|
| Complete Case     | -2.829   | 1.117 | -5.035 to -0.623 | 0.0123  |
| MI - MAR (B=500)  | -2.819   | 1.125 | -5.042 to -0.596 | 0.0133  |
| MI - MAR (B=2000) | -2.834   | 1.125 | -5.058 to -0.610 | 0.0129  |
| MI - MAR (B=5000) | -2.812   | 1.122 | -5.029 to -0.595 | 0.0133  |
| MI - MNAR CR (B=500)  | -2.393 | 1.118 | -4.603 to -0.183 | 0.0340 |
| MI - MNAR CR (B=2000) | -2.407 | 1.117 | -4.615 to -0.200 | 0.0327 |
| MI - MNAR CR (B=5000) | -2.387 | 1.115 | -4.590 to -0.185 | 0.0338 |
| MI - MNAR J2R (B=500)  | -2.131 | 1.139 | -4.382 to	0.121 | 0.0634 |
| MI - MNAR J2R (B=2000) | -2.153 | 1.139 | -4.405 to	0.098 | 0.0607 |
| MI - MNAR J2R (B=5000) | -2.131 | 1.134 | -4.372 to	0.110 | 0.0622 |
| MI - MNAR CIR (B=500)  | -2.470 | 1.118 | -4.680 to	-0.261 | 0.0287 |
| MI - MNAR CIR (B=2000) | -2.487 | 1.116 | -4.694 to	-0.281 | 0.0274 |
| MI - MNAR CIR (B=5000) | -2.467 | 1.114 | -4.670 to	-0.265 | 0.0284 |


## Discussion
To add last.

A note on computational time. The total running time (including data loading, setting up data sets, MCMC run, imputing data and analysis MI data) for B=500 was about 23 seconds on a personal laptop. It increased to about 44 seconds for B=2000. Computational time was similar across difference imputation strategies.

With a small number of `Ndraws` in part1B a warning could pop-up "There is still significant autocorrelation after 5 lags, and the effective sample size for the parameter might not be estimated accurately.". Increasing the number of `Ndraws` will mostly solve this warning. For example, for this data example, this message is received when setting `Ndraws` equal to 50 or 100.

## Appendix 1: mmrm as analysis model

Part 3 of the 5 macros carries out a univariate ANOVA analysis at selected time points usually based on the same covariates as the parameter estimation model. It then combines the least-squares means and their differences using Rubinâ€™s formula in a calculation similar to that in the MIANALYZE procedure to provide final results.

Since, all imputed datasets are readily available (after part2B), another possibility is to analyse each imputed dataset using the analysis model of your choice, and combining the results using `PROC MIANALYZE`. For example, suppose an MMRM should be fit on each imputed dataset:

```{r}
#| eval: false
data HAMD_CR_DATAFULL;
	set HAMD_CR_DATAFULL;
	_Imputation_ = draw;
run;	

proc mixed data=HAMD_CR_DATAFULL ;
	by _Imputation_;
	class THERAPY(ref="PLACEBO") VISIT PATIENT GENDER;
	model CHANGE = THERAPY VISIT BASVAL BASVAL*VISIT THERAPY*VISIT GENDER /s;
	repeated / 	type=UN subject=PATIENT;
	lsmeans THERAPY*VISIT / diff=control("PLACEBO" "7");
	ods output Diffs=diff01;
run;	

proc mianalyze parms=diff01(where=(VISIT="7"));
	class THERAPY VISIT;
	modeleffects THERAPY*VISIT;
	ods output ParameterEstimates=res01;
run;
```

The results for 500 imputations are
```{r, echo=FALSE, fig.align='center', out.width="90%"}
knitr::include_graphics("../images/rbmi/SAS_MNAR_mmrm.PNG")
```

## Reference

[5 macros: LSHTM DIA Missing Data](https://www.lshtm.ac.uk/research/centres-projects-groups/missing-data#dia-missing-data)

[PROC MIANALYZE](https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.3/statug/statug_mianalyze_toc.htm)

