---
title: "Generalized Estimating Equations (GEE) methods"
---

# INTRODUCTION

Generalized Estimating Equations (GEE) methods extend the Generalized Linear Model (GLM) framework using link functions that relate the predictors to transformed outcome variable. For dichotomous response variables, the link functions is the probit (in case of rare events complementary log-log may be preferable). For outcomes with more than two categories, the cumulative link function is used in case of ordinal variables and generalized logit for nominal variables.

GEE are marginal models and therefore estimate population-averaged effects and within-subject correlation is analysed by specifying a working correlation structure (as in MMRM). Estimators are obtained via quasi-likelihood via iterative solving of estimating equations.

# EXAMPLE DATA

A SAS data of clinical trial data comparing two treatments for a respiratory disorder available in ["Gee Model for Binary Data"](https://documentation.sas.com/doc/en/statug/15.2/statug_code_genmex5.htm) in the SAS/STAT Sample Program Library \[1\] is used to create these examples.

To uniquely identify subjects, a new variable USUBJID was created by concatenating SITE and ID. Variables TREATMENT, BASELINE, and VISIT were renamed to TRTP, BASE, and AVISITN.

Additionally, two variables were created using randomly generated values to simulate variables with more than two categories. One was an ordinal variable with values 1, 2, and 3; the other was a nominal variable with categories 'liver', 'lung', and 'bone'. Data were created in SAS (See SAS section), and imported to R.

```{r}
#install.packages("readxl")
library(readxl)
resp <- read_excel("../data/resp.xlsx")
```

Variables OUTCOME, TRTP and AVISITN were converted to factors. Since the modeling functions use the first (alphabetically) level as the reference category, TRTP levels are ordered as 'P' (placebo) and 'A' (active), to ensure that placebo is used as the reference category in the models:

```{r}
resp$trtp<-factor(resp$trtp, levels=c('P', 'A'))
resp$avisitn<-factor(resp$avisitn)
resp$outcome<-factor(resp$outcome)
resp$usubjid<-factor(resp$usubjid)
resp$respnom<-factor(resp$respnom)
```

GEE models are run in the next section, including treatment, visit and visit by treatment interaction as fixed effects.

# PACKAGES

```{r}
#| echo: false
#| include: false
#install.packages("geepack")
#install.packages("gee")
#install.packages("multgee")
#install.packages("emmeans")
#install.packages("multgee")
library(geepack)
library(gee)
library(multgee)
library(emmeans)
library(multgee)
```

# BINARY OUTCOME

Binary outcomes can be analyzed with `geepack::geelm` \[2\] and and `gee::gee` \[3\] functions. Independence correlation matrix is used by default in both functions, and can be modified in the `corstr=` argument.

Both functions estimate robust "Sandwich" standard errors (SE) by default, and the gee::gee function also returns the naive SE (model-based SE).

```{r}
#Create numeric outcome (values: 1/0).
resp$outcome_num<-as.numeric(resp$outcome)-1

model <- geepack::geeglm(outcome_num ~ trtp + avisitn +trtp*avisitn,
                id=usubjid,
                data=resp,
                family=binomial(link='logit'),
                corstr="independence")
summary(model)
```

```{r}
model<- gee::gee(outcome ~ trtp + avisitn + trtp*avisitn,
            id=usubjid,
            data=resp,
            family=binomial(link='logit'),
            corstr = "independence")
summary(model)
```

### PROBABILITIES AND ODDS RATIO (OR)

The estimated probabilities of event and OR can be obtained using the `emmeans` function from a `geepack::geeglm` object. The code below computes probabilities and OR, along with p-values.

```{r}
model <- geepack::geeglm(outcome_num ~ trtp + avisitn +trtp*avisitn,
                id=usubjid,
                data=resp,
                family=binomial(link='logit'),
                corstr="independence")


#Get predicted probabilities for each treatment.
#Get predicted probabilities for each treatment, using the covariance matrix computed by the model
prob <- emmeans::emmeans(model, ~ trtp*avisitn, data=resp, vcov.method=vcov(model), type='response')
prob

#Get differences between treatments by visit (option "revpairwise" is used to compare A vs P) 
diffs_mean<-emmeans::emmeans(model, ~ trtp*avisitn, data=resp, vcov.method=vcov(model))
diffs <- contrast(diffs_mean,"revpairwise" , simple="trt")
diffs <- as.data.frame(diffs)

#Calculate CI (alpha=0.05)
alpha<-0.05
z_crit <- qnorm(1 - alpha / 2)
diffs$low<-diffs$estimate - (z_crit*diffs$SE)
diffs$upp<-diffs$estimate + (z_crit*diffs$SE)

#Get OR applying exponential transformation;
or<-exp(diffs$estimate)
or_low<-exp(diffs$low)
or_upp<-exp(diffs$up)

#Get two-sided p-value
z <- diffs$estimate/diffs$SE
pvalue <- 2 * (1 - pnorm(z))

#Create a dataset with all the results
OR<-as.data.frame(cbind(diffs$avisitn, or,or_low, or_upp, z, round(pvalue, digits=4)))
colnames(OR)<-c('avisit', 'OR', 'lower.CL', 'upper.CL', 'Z', 'p-value')
OR
```

# OUTCOME WITH MORE THAN TWO CATEGORIES

The functions used for binary outcomes above do not support outcomes with more than two categories, as these functions relay on the family function, which does not include the multinomial option. Nevertheless, the multgee package \[4\] provides two functions for estimating GEE models when the outcome has more than two categories:

The correlation matrix by default is "Exchangeable", and it can be modified using the `LORstr=` argument in both functions.

### Ordinal variable

```{r}
model <- multgee::ordLORgee(formula = respord ~ trtp + avisitn  + trtp*avisitn,
                   data = resp,
                   id = usubjid,
                   repeated = avisitn,
                   LORstr="time.exch",
                   )

summary(model)
```

### Nominal variable

```{r}
model <- multgee::nomLORgee(formula = respnom ~ trtp + avisitn  + trtp*avisitn,
                   data = resp,
                   id = usubjid,
                   repeated = avisitn,
                   LORstr = "time.exch")
                   
        
summary(model)
```

# REFERENCES

\[1\] [SAS Institute Inc.. SAS Help Center. The GEE procedure.](https://documentation.sas.com/doc/en/statug/15.2/statug_gee_examples01.htm)

\[2\] [Generalized Estimating Equation Package](https://cran.r-project.org/web/packages/geepack/geepack.pdf)

\[3\] [Generalized Estimation Equation Solver](https://cran.r-project.org/web/packages/gee/gee.pdf)

\[4\] [Touloumis A. (2015). "R Package multgee: A Generalized Estimating Equations Solver for Multinomial Responses." Journal of Statistical Software.](https://www.jstatsoft.org/article/view/v064i08)
