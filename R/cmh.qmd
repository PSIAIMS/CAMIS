---
title: "CMH Test"
---

# Cochran-Mantel-Haenszel Test

The classical CMH procedure tests for conditional independence in partial contingency tables for a 2 x 2 x K design. However, it can be generalized to tables of X x Y x K dimensions.

## Available R packages

We did not find any R package that delivers all the same measures as SAS at once. Therefore, we tried out multiple packages:

```{r}
#| echo: false
#| warning: false
#| message: false
library(gt)
library(tibble)
library(dplyr)

# table approach inspired by Sharla - https://sharla.party/post/comparing-two-dfs/
yes <- "\U2705"
no <- "\U274C"

tribble(
  ~Package, ~`General Association`, ~`Row Means Differ`, ~`Nonzero Correlation`, ~`M-H Odds Ratio`, ~`Homogeneity Test`, ~Note,
 "stats::mantelhaen.test()", yes, no, no, yes, no, "Only provides common OR with confidence interval for 2x2xK. For the generalized case, the p-value is provided only",
 "vcdExtra::CMHtest()", yes, yes, yes, no, yes,"Problems with sparsity in case of many strata; Do not use the types argument"
 ) |>
  gt::gt()
```

## Data used

We will use the CDISC Pilot data set, which is publicly available on the PHUSE Test Data Factory repository. This data set served as the basis of the examples to follow.

```{r}
#| echo: false
data <- read.csv("../data/adcibc.csv")
head(data)
```

## Example Code

### Base R

This is included in a base installation of R, as part of the default `stats` package. Requires inputting data as a *table* or as *vectors*. Two examples 2x2x2 examples: X=2 treatments, Y=Sex (M/F), controlling for 2 age groups and 3x2x3 example X=3 treatments, Y=Sex (M/F), controlling for 3 age groups.

By default, a continuity correction is applied when computing the test statistic for the 2 x 2 x K cases. This can be turned off by `correct=FALSE`

```{r}
# 2x2x2 example
data2 <- data |>
  dplyr::filter(TRTPN != "54" & AGEGR1 != ">80")

stats::mantelhaen.test(x = data2$TRTP, y = data2$SEX, z = data2$AGEGR1)
stats::mantelhaen.test(x = data2$TRTP, y = data2$SEX, z = data2$AGEGR1, correct=FALSE)

# 3x2x3 example
stats::mantelhaen.test(x = data$TRTP, y = data$SEX, z = data$AGEGR1)
```

### vcdExtra

The `vcdExtra` package provides results for the generalized CMH test, for each of the three model it outputs the Chi-square value and the respective p-values. Flexible data input methods available: *table* or *formula* (aggregated level data in a data frame).

```{r}
library(vcdExtra)

# Formula: Freq ~ X + Y | K

# case 2 x 2 x 2 (no continuity correction is applied)
vcdExtra::CMHtest(Freq ~ TRTP + SEX | AGEGR1, data = data2, overall = TRUE)

# case 3 x 2 x 3
vcdExtra::CMHtest(Freq ~ TRTP + SEX | AGEGR1, data = data, overall = TRUE)
```

Using the `vcd` package, the odds ratio for each 2x2 table can be calculated and the Woolf-test on Homogeneity of Odds Ratios can be performed.

```{r}
tab0 = table(data2$TRTP, data2$SEX, data2$AGEGR1)
vcd::oddsratio(tab0, log=FALSE)
vcd::woolf_test(tab0)
```

Note the Woolf test is available in other packages, for example `DescTools`.
```{r}
library(DescTools)
DescTools::WoolfTest(tab0)
```


### Forked Version of vcdExtra - Solution for sparse data

To tackle the [issue with sparse data](https://github.com/friendly/vcdExtra/issues/3) it was suggested that `solve()` is replaced with `MASS::ginv`. This was implemented in the forked version of vcdExtra (https://github.com/mstackhouse/vcdExtra). However this was never implemented in the vcdExtra package itself, and therefore never extensively tested.


# References

Accessible Summary: https://online.stat.psu.edu/stat504/lesson/4/4.4

An Introduction to Categorical Data Analysis 2nd Edition (Agresti): http://users.stat.ufl.edu/\~aa/

Original Paper 1: https://doi.org/10.2307%2F3001616

Original Paper 2: https://doi.org/10.1093/jnci/22.4.719
